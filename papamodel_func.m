function [Hb,Kni,Kr,Gt]=papamodel_func(n)
%PAPAMODEL_FUNC reoccur of papamodel
%independent parameter
global N C Ka_Hb_R Ka_Kr Ka_Others abs_conc Syn_rate diff_rate
N=4;
C=10^0.52;
Ka_Hb_R=10^8.1;
Ka_Kr=10^8.3;
Ka_Others=10^7.3;2011
abs_conc=10^7.3;
Syn_rate=2.9;
diff_rate=0.18;
%dependent parameter
global alpha beta Diff
alpha=Syn_rate*2.25/50;
beta=1-alpha;
Diff=diff_rate*180/25/2;
%maternal inputs
global mHb mBcd mTll
mHb=[0.454449970000000;0.515901244000000;0.575482279000000;
    0.622881891000000;0.659819389000000;0.691982452000000;
    0.724951901000000;0.753149568000000;0.777231075000000;
    0.798095867000000;0.816781896000000;0.835013313000000;
    0.852978136000000;0.871204789000000;0.889120129000000;
    0.906086996000000;0.922068579000000;0.937097541000000;
    0.950597567000000;0.962262921000000;0.972260049000000;
    0.980598027000000;0.987322006000000;0.992719055000000;
    0.996543593000000;0.998953861000000;1;0.999445055000000;
    0.996702898000000;0.991685622000000;0.984218739000000;
    0.973910567000000;0.960525293000000;0.944193722000000;
    0.924771595000000;0.902416838000000;0.877219986000000;
    0.849056828000000;0.817730243000000;0.783552094000000;
    0.746776155000000;0.707507797000000;0.665792556000000;
    0.621869240000000;0.576217087000000;0.529509868000000;
    0.482407849000000;0.435520713000000;0.389672904000000;
    0.346055445000000;0.305412794000000;0.268055547000000;
    0.234184672000000;0.203971161000000;0.177379147000000;
    0.154058718000000;0.133606107000000;0.115698588000000;
    0.100011865000000;0.0862137180000000;0.0739845570000000;
    0.0632717900000000;0.0539525070000000;0.0458786230000000;
    0.0388799040000000;0.0328271170000000;0.0275426430000000;
    0.0229252760000000;0.0188610420000000;0.0152783640000000;
    0.0121008380000000;0.00935139800000000;0.00699676500000000;
    0.00503529400000000;0.00345215900000000;0.00222570000000000;
    0.00130532900000000;0.000668645000000000;0.000276260000000000;
    7.35194000000000e-05;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0];
mBcd=[0.998667353000000;0.999385152000000;0.996132059000000;
    0.990248835000000;0.980577872000000;0.967620018000000;
    0.952696862000000;0.936410449000000;0.918786721000000;
    0.898603350000000;0.875135028000000;0.848047763000000;
    0.818226544000000;0.786243606000000;0.752653443000000;
    0.717894420000000;0.683253784000000;0.649738611000000;
    0.617602633000000;0.586044997000000;0.554700039000000;
    0.524148153000000;0.495392941000000;0.468595494000000;
    0.443171331000000;0.418717369000000;0.395602725000000;
    0.374366583000000;0.354844778000000;0.336134578000000;
    0.317365528000000;0.298428562000000;0.279882220000000;
    0.262334951000000;0.245979448000000;0.230715858000000;
    0.216469070000000;0.203227778000000;0.190953799000000;
    0.179484506000000;0.168597416000000;0.158092986000000;
    0.147855431000000;0.137917657000000;0.128408274000000;
    0.119402199000000;0.110869604000000;0.102744999000000;
    0.0950138170000000;0.0876968050000000;0.0807860310000000;
    0.0742922820000000;0.0682767860000000;0.0627891600000000;
    0.0578079070000000;0.0532246990000000;0.0488970710000000;
    0.0447334700000000;0.0407445460000000;0.0369903720000000;
    0.0334986500000000;0.0302484980000000;0.0272009180000000;
    0.0243380830000000;0.0216661140000000;0.0192037340000000;
    0.0169559410000000;0.0149302130000000;0.0131218020000000;
    0.0115189250000000;0.0100970340000000;0.00883521900000000;
    0.00771500400000000;0.00672255000000000;0.00584509600000000;
    0.00507090800000000;0.00438923200000000;0.00379024000000000;
    0.00326497600000000;0.00280530100000000;0.00240384300000000;
    0.00205393800000000;0.00174958300000000;0.00148538200000000;
    0.00125650000000000;0.00105861400000000;0.000887870000000000;
    0.000740840000000000;0.000614484000000000;0.000506113000000000;
    0.000413351000000000;0.000334108000000000;0.000266549000000000;
    0.000209066000000000;0.000160248000000000;0.000118876000000000;
    8.38792000000000e-05;5.47341000000000e-05;3.15127000000000e-05;
    1.19828000000000e-05];
mTll=[0;4.81663000000000e-06;0.000966782000000000;0.00508340700000000;
    0.0156164330000000;0.0338894070000000;0.0587216150000000;
    0.0883885160000000;0.122031224000000;0.158587280000000;
    0.195010729000000;0.226787164000000;0.249837464000000;
    0.260519493000000;0.255295118000000;0.232876640000000;
    0.196781008000000;0.154446512000000;0.113365919000000;
    0.0780989810000000;0.0502492120000000;0.0298184470000000;
    0.0159910670000000;0.00746515400000000;0.00285056300000000;
    0.000819070000000000;0.000159739000000000;1.84898000000000e-05;
    1.02487000000000e-06;1.73384000000000e-08;2.84218000000000e-11;
    0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;
    7.58756000000000e-12;1.60120000000000e-08;1.25477000000000e-06;
    1.99018000000000e-05;0.000118965000000000;0.000398750000000000;
    0.00100076200000000;0.00224506000000000;0.00478764300000000;
    0.00952583200000000;0.0171056150000000;0.0275047940000000;
    0.0405482160000000;0.0571190700000000;0.0794175500000000;
    0.109675068000000;0.149111219000000;0.198757495000000;
    0.260597570000000;0.336411891000000;0.425063978000000;
    0.521566423000000;0.619149290000000;0.711728863000000;
    0.794556710000000;0.864087880000000;0.918314940000000;
    0.956946112000000;0.980167061000000;0.986643396000000;
    0.973577551000000;0.938891325000000;0.884160353000000;
    0.819625329000000;0.751144568000000];
[Hb,Kni,Kr,Gt]=papa_equation(n);

function [Hb,Kni,Kr,Gt]=papa_equation(recurtionTime)
global N C Ka_Hb_R Ka_Kr Ka_Others abs_conc alpha beta Diff mHb mBcd mTll
ZERO=zeros(100,1);
pR_ONE=C./(C+(1+C.*ZERO.*(Ka_Others/abs_conc)).^N-1);
% calculate p
mCad=C./(C+(1+C.*mBcd.*(Ka_Others/abs_conc)).^N-1);
pA_Bcd=((1+C.*mBcd.*(Ka_Others/abs_conc)).^N-1)./(C+(1+C.*mBcd.*(Ka_Others/abs_conc)).^N-1);
pA_Cad=((1+C.*mCad.*(Ka_Others/abs_conc)).^N-1)./(C+(1+C.*mCad.*(Ka_Others/abs_conc)).^N-1);
pA_Hb=((1+C.*mHb.*(Ka_Others/abs_conc)).^N-1)./(C+(1+C.*mHb.*(Ka_Others/abs_conc)).^N-1);
pDR_Hb=C./(C+(1+C.*mHb.*(Ka_Others/abs_conc)).^N-1);
pR_Hb=C./(C+(1+C.*mHb.*(Ka_Hb_R/abs_conc)).^N-1);
pR_Tll=C./(C+(1+C.*mTll.*(Ka_Others/abs_conc)).^N-1);
P_Kr=pA_Hb.*pDR_Hb;
P_Kni=pA_Bcd.*pR_Hb;
P_Gt=1-(1-pA_Bcd).*(1-pA_Cad);
% calculate p end
% small trick
synKr=4;
synKni=max(P_Gt)/(max(P_Kni)+0.01);
% recursion begin
synDecHb=beta.*mHb+alpha.*pA_Bcd.*pA_Hb.*pR_ONE;
synDecGt=beta.*ZERO+alpha.*P_Gt.*pR_Tll.*pR_ONE;
synDecKr=beta.*ZERO+alpha.*synKr.*P_Kr.*pR_ONE;
synDecKni=beta.*ZERO+alpha.*synKni.*P_Kni.*pR_Tll;
Hb=synDecHb.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecHb);
Gt=synDecGt.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecGt);
Kr=synDecKr.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecKr);
Kni=synDecKni.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecKni);
for step=1:recurtionTime-1
pA_Hb=((1+C.*Hb.*(Ka_Others/abs_conc)).^N-1)./(C+(1+C.*Hb.*(Ka_Others/abs_conc)).^N-1);
pDR_Hb=C./(C+(1+C.*Hb.*(Ka_Others/abs_conc)).^N-1);
pR_Hb=C./(C+(1+C.*Hb.*(Ka_Hb_R/abs_conc)).^N-1);
pR_Kr=C./(C+(1+C.*Kr.*(Ka_Kr/abs_conc)).^N-1);
pR_Kni=C./(C+(1+C.*Kni.*(Ka_Others/abs_conc)).^N-1);
pR_Gt=C./(C+(1+C.*Gt.*(Ka_Others/abs_conc)).^N-1);
P_Kr=pA_Hb.*pDR_Hb;
P_Gt=1-(1-pA_Bcd).*(1-pA_Cad);
synDecHb=beta.*Hb+alpha.*pA_Bcd.*pA_Hb.*pR_Kni;
synDecGt=beta.*Gt+alpha.*P_Gt.*pR_Tll.*pR_Kr;
synDecKr=beta.*Kr+alpha.*synKr.*P_Kr.*pR_Gt;
synDecKni=beta.*Kni+alpha.*synKni.*pA_Bcd.*pR_Hb.*pR_Tll;
Hb=synDecHb.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecHb);
Gt=synDecGt.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecGt);
Kr=synDecKr.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecKr);
Kni=synDecKni.*(1-Diff)+Diff.*Papa_Sec_Order_Partial_diff(synDecKni);
end

function [ Matout ] = Papa_Sec_Order_Partial_diff( Matin )
%Papa_Sec_Order_Partial_diff:calculate the Partial differential of a matrix
%   if index<=4 average(1:index+3)
%   if index>4&&index<=index-3 average(index-3:index+3)
%   if index>length-3 average(index-3,length)
Matout=Matin;
for index=1:length(Matin)
    if index<=4
        Matout(index)=mean(Matin(1:index+3));
    end
    if index>4&&index<=length(Matin)-3
        Matout(index)=mean(Matin(index-3:index+3));
    end
    if index>length(Matin)-3
        Matout(index)=mean(Matin(index-3:length(Matin)));
    end
end
